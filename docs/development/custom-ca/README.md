# Using a custom intermediate CA in Istio

## Background

Imagine you work for a big company that runs its own PKI. Most of these companies manage their own Root CA and generate
intermediate CAs to sign Clients and/or Server Certificates.

As Istio is capable of issuing certificates for every workload inside a mesh, it is possible to provide a custom CA
to sign the workload's certificates instead of using the self-signed one.

## Requirements

Ensure to have the following files:

- `certs/ca-cert.pem`: Certificate of the Intermediate CA.
- `certs/ca-key.pem`: Private key of the Intermediate CA.
- `certs/root-cert.pem`: Certificate of the Root CA.
- `certs/cert-chain.pem`: Certificate Chain. `cat certs/ca-cert.pem certs/root-cert.pem > certs/cert-chain.pem`.

Also, it's required to know what `katalog/istio/sidecar-injection/configuration` was used as some tuning will be
needed.

_Optional_ : you can generate by yourself the certificate using this [script](https://raw.githubusercontent.com/istio/istio/master/tools/certs/Makefile.selfsigned.mk). Give a look to this [link](https://istio.io/v1.9/docs/tasks/security/cert-management/plugin-ca-cert/#plug-in-certificates-and-key-into-the-cluster) on how to use it.

### Hands on

#### Istio Sidecar Configuration

Look into the `kustomization.yaml` file.

_Example Istio `kustomization.yaml` file:_

```yaml
bases:
  - ../vendor/katalog/service-mesh/istio-operator/profiles/minimal # you can choose between these flavours: minimal, full, tracing
```

#### Kustomize

Ensure to have the following files configured:

```bash
$ tree
.
├── certs
│   ├── ca-cert.pem
│   ├── ca-key.pem
│   ├── cert-chain.pem
│   └── root-cert.pem
├── kustomization.yaml

2 directories, 7 files
```

Run kustomize build to check everything is well configured:

```bash
kustomize build .
```

What kustomize does is to override the default istio deployment:

- Creates a new Kubernetes secret named `cacerts` with the content of every file inside the `certs` directory.

Apply it

```bash
kustomize build . | kubectl apply -f - -n istio-system
```

### Test it

To make sure the workloads obtain the new certificates promptly, delete the secrets generated by Istio
_(named as istio.\*)_. In this example, `istio.default`. Istio will issue new certificates for the workloads.

```bash
kubectl delete secret istio.default
```

## Links

- <https://istio.io/v1.9/docs/tasks/security/cert-management/plugin-ca-cert/>
- <https://istio.io/v1.9/docs/tasks/security/cert-management/custom-ca-k8s/> # this is experimental
- <https://github.com/istio/istio/blob/1.9.5/tools/certs/Makefile.selfsigned.mk>
- <https://jamielinux.com/docs/openssl-certificate-authority/create-the-root-pair.html>
